import streamlit as st
import google.generativeai as genai

# 1. ページ設定（最も標準的な設定）
st.set_page_config(page_title="脳内物質デバッガー", page_icon="🧠")

st.title("🧠 脳内物質翻訳デバッガー")
st.write("脳科学と心理学に基づく精密分析。具体的な行動を提案します。")

# 2. APIキーの設定
if "GEMINI_API_KEY" not in st.secrets:
    st.error("Streamlitの管理画面で『GEMINI_API_KEY』を設定してください。")
    st.stop()

genai.configure(api_key=st.secrets["GEMINI_API_KEY"])

# 有料プランで最も推奨される最新モデル
model = genai.GenerativeModel('gemini-2.5-flash') 

# 3. 入力エリア（エラーが起きにくいシンプルな設定に変更）
user_input = st.text_area(
    "今の状況（悩み、思考、体調など）を教えてください", 
    placeholder="（例）嫌なことを考え続けてしまう / ぼーっとしてしまい集中できない 等",
    height=150
)

st.caption("⚠️ 個人情報は入力しないでください。")

# 4. 実行処理
if st.button("デバッグを開始する"):
    if user_input:
        with st.spinner("分析中..."):
            # 有料プランのメリット（データ非学習・回数制限緩和）を活かす高精度指示
            prompt = f"""
あなたは脳科学、神経科学、および臨床心理学の権威であり、ユーザーが自分自身の「直（すなお）」な状態に立ち返るのを支援する最良のパートナーです。
提示された状況から現在の脳内物質の動態を推論し、対照的な2つの解決アプローチを提示してください。

【回答の基本理念：直（すなお）】
「直」とは、今の自分の状態を脚色せず、良い・悪いの判断を脇に置いて、ありのままに認めることです。
ユーザーが「納得いかない」と感じる反応も、大切な「直」なデータとして尊重してください。

【回答の構成ルール】
1. **現状の脳内スキャン（分析）**: 
   記述から「ドーパミン」「セロトニン」「ノルアドレナリン」等のバランスを推定し、科学的に言語化してください。

2. **「静（せい）」のデバッグ（ゆっくり休む）**: 
   脳のオーバーヒートを抑え、DMN（デフォルト・モード・ネットワーク）を起動して情報を整理する「停止」のアプローチ。なぜ今「何もしないこと」が科学的に必要なのか解説してください。

3. **「動（どう）」のデバッグ（アクションを起こす）**: 
   報酬系を再起動し、停滞したエンジンをかけるための「駆動」のアプローチ。身体を動かす、刺激を入れる等の具体的な行動と、その生物学的メリットを解説してください。

4. **メカニズムの科学的詳説**: 
   それぞれの行動がどの物質にどう作用するのか、専門用語を交えつつ、ありきたりな精神論を排除して解説してください。

5. **「直（すなお）」な感覚への問いかけ**: 
   最後に、「今のあなたの直な感覚では、どちらがしっくりきますか？」と問いかけてください。また、「もしどちらも納得いかない場合は、画面下のボタンから教えてください」と一言添えてください。

ユーザーの状況:
{user_input}
"""
            
            try:
                response = model.generate_content(prompt)
                
                if response.text:
                    st.subheader("🛠 分析結果と提案")# --- response.text を表示した後のブロック ---
st.divider() # 区切り線

# 不満・問い合わせ用のエクスパンダー
with st.expander("💡 提案に納得がいかない、または直接相談したい方へ"):
    st.write("AIの提案が『直（すなお）』な感覚としっくりこない場合は、以下のオプションをご利用ください。")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("別の視点で再分析する"):
            st.info("さらに具体的なエピソードや、今の『納得いかない』という気持ちを書き足して、もう一度ボタンを押してみてください。")
    
    with col2:
        # ここにLINEや問い合わせフォーム、カウンセリング予約サイトのURLを入れます
        st.link_button("直接問い合わせ・専門家に相談", "https://your-contact-link.com")

    st.markdown("---")
    st.caption("※あなたの不満や違和感も、自分を整えるための大切なサインです。")
                    st.markdown(response.text)
                    
                    st.caption("※本内容は医学的診断ではありません。")
                else:
                    st.error("AIからの返答が空でした。もう一度送信してください。")

            except Exception as e:
                st.error(f"エラーが発生しました。時間を置いてお試しください。({e})")
    else:
        st.info("分析したい内容を入力してください。")




