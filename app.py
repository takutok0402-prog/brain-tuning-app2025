import streamlit as st
import google.generativeai as genai
import os

# 1. ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(
    page_title="è„³å†…ç‰©è³ªãƒ‡ãƒãƒƒã‚¬ãƒ¼ | Professional", 
    page_icon="ğŸ§ ",
    layout="centered"
)

# --- 2. APIã‚­ãƒ¼ã®è¨­å®šï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆã‚’çµ±åˆï¼‰ ---
# st.secretsã‚’ç›´æ¥è§¦ã‚‰ãšã€ã¾ãšç’°å¢ƒå¤‰æ•°(os.getenv)ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
api_key = os.getenv("GEMINI_API_KEY")

# ç’°å¢ƒå¤‰æ•°ã«ãªã„å ´åˆã®ã¿ã€ä¾‹å¤–å‡¦ç†ã‚’æŒŸã‚“ã§st.secretsã‚’è¦‹ã«è¡Œã
if not api_key:
    try:
        # Streamlit Cloudç’°å¢ƒç”¨ã®å‡¦ç†
        api_key = st.secrets["GEMINI_API_KEY"]
    except Exception:
        # ã©ã¡ã‚‰ã«ã‚‚ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        api_key = None

if not api_key:
    st.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Renderã®'Environment'è¨­å®šã€ã¾ãŸã¯Secretsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# éµã‚’é©ç”¨
genai.configure(api_key=api_key)

# æœ‰æ–™ãƒ—ãƒ©ãƒ³ï¼ˆå¾“é‡èª²é‡‘ï¼‰ã§æœ€ã‚‚æ¨å¥¨ã•ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆâ€»2.5-flashãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆã¯1.5-flashã‚’ãŠè©¦ã—ãã ã•ã„ï¼‰
model = genai.GenerativeModel('gemini-2.5-flash')

# 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚¨ãƒªã‚¢
st.title("ğŸ§  è„³å†…ç‰©è³ªç¿»è¨³ãƒ‡ãƒãƒƒã‚¬ãƒ¼")
st.markdown("#### ğŸ“¥ ç¾åœ¨ã®çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
user_input = st.text_area(
    label="çŠ¶æ³è©³ç´°",
    label_visibility="collapsed",
    placeholder="ï¼ˆä¾‹ï¼‰å«Œãªã“ã¨ãŒé ­ã‹ã‚‰é›¢ã‚Œãšã€ä½•ã‚‚æ‰‹ã«ã¤ã‹ãªã„...",
    height=150
)

# 4. ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
if st.button("ğŸš€ ãƒ•ãƒ«ãƒ»ã‚¹ã‚­ãƒ£ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹", use_container_width=True):
    if user_input:
        with st.spinner("è„³å†…ã®å…¨ãƒã‚¤ã‚ªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è§£æä¸­..."):
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¼·åŒ–ï¼šè©³ç´°ãªç‰©è³ªåˆ†æã‚’ä¾é ¼
            prompt = f"""
            ã‚ãªãŸã¯ç¥çµŒç§‘å­¦ã¨è‡¨åºŠå¿ƒç†å­¦ã®æ¨©å¨ã§ã™ã€‚ä»¥ä¸‹ã®çŠ¶æ³ã‚’ã€Œè„³å†…ãƒ‡ãƒãƒƒã‚°ã€ã—ã¦ãã ã•ã„ã€‚
            ã€åˆ†æã®å¿…é ˆé …ç›®ã€‘
            1. ä¼é”ç‰©è³ªãƒãƒ©ãƒ³ã‚¹ï¼šDA(æœŸå¾…), 5-HT(å®‰å®š), NA(é›†ä¸­/ç·Šå¼µ), OT(æ„›/çµ†), GABA(æŠ‘åˆ¶)ã®çŠ¶æ…‹ã€‚
            2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è§£æï¼šDMN(å†…çœ)ã®æš´èµ°åº¦ã€TPN(å®Ÿè¡Œ)ã¸ã®åˆ‡ã‚Šæ›¿ãˆã€SN(å¸ä»¤å¡”)ã®ç–²åŠ´ã€‚
            3. ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ï¼šã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆã®æœ‰ç„¡ã€‚
            4. è«–ç†çš„æ ¹æ‹ ï¼šãªãœç‰¹å®šã®éŸ³æ¥½ã‚„é‹å‹•ãŒãƒ‡ãƒãƒƒã‚°ã«æœ‰åŠ¹ãªã®ã‹ã€‚
            çŠ¶æ³: {user_input}
            """
            
            try:
                response = model.generate_content(prompt)
                if response and response.text:
                    st.session_state.result = response.text
                    st.session_state.show_result = True
            except Exception as e:
                st.error(f"ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: {e}")
    else:
        st.info("ã¾ãšã¯çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# 5. åˆ†æçµæœã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º
if st.session_state.get('show_result'):
    st.markdown("---")
    st.markdown("### ğŸ” è„³å†…ãƒ‡ãƒãƒƒã‚°å ±å‘Šæ›¸")
    st.markdown(st.session_state.result)

    # ç‰©è³ªã®çŠ¶æ…‹ã‚’å¤šè§’çš„ã«è¡¨ç¤º
    st.divider()
    st.subheader("ğŸ“Š è©³ç´°ç‰©è³ªãƒãƒ©ãƒ³ã‚¹ï¼ˆæ¨æ¸¬ï¼‰")
    cols = st.columns(3)
    with cols[0]:
        st.progress(20, text="5-HT (ã‚»ãƒ­ãƒˆãƒ‹ãƒ³)")
        st.progress(10, text="DA (ãƒ‰ãƒ¼ãƒ‘ãƒŸãƒ³)")
    with cols[1]:
        st.progress(80, text="NA (ãƒãƒ«ã‚¢ãƒ‰)")
        st.progress(15, text="OT (ã‚ªã‚­ã‚·ãƒˆã‚·ãƒ³)")
    with cols[2]:
        st.progress(5, text="GABA (æŠ‘åˆ¶åŠ›)")
        st.progress(90, text="Cortisol (ã‚¹ãƒˆãƒ¬ã‚¹)")

    # 2ã¤ã®ãƒ«ãƒ¼ãƒˆé¸æŠ
    st.markdown("---")
    st.subheader("ğŸ’¡ ã©ã¡ã‚‰ã®ãƒ‡ãƒãƒƒã‚°ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ")
    c1, c2 = st.columns(2)
    with c1:
        if st.button("ğŸš€ å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼ˆå¤–ã¸é›†ä¸­ï¼‰"):
            st.session_state.mode = 'reset'
    with c2:
        if st.button("ğŸŒ¿ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»èª¿å¾‹ï¼ˆå†…ã‚’ç™’ã‚„ã™ï¼‰"):
            st.session_state.mode = 'tuning'

# 6. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºï¼ˆé¸æŠã•ã‚ŒãŸå ´åˆï¼‰
if st.session_state.get('mode'):
    mode = st.session_state.mode
    st.info(f"ã€{'å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ' if mode=='reset' else 'ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»èª¿å¾‹'}ã€‘ç”¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚")
    # ã“ã“ã«éŸ³æ¥½ãƒªã‚¹ãƒˆã‚„å‹•ç”»ã‚¿ãƒ–ã‚’è¡¨ç¤º
    st.tabs(["ğŸµ éŸ³æ¥½", "ğŸ“º å‹•ç”»", "ğŸƒ é‹å‹•"])
# --- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãƒãƒƒãƒï¼ˆä¸æº€ãƒ»å•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ï¼‰ ---
                    st.divider() 
                    with st.expander("ğŸ’¡ ææ¡ˆã«ç´å¾—ãŒã„ã‹ãªã„ã€ã¾ãŸã¯ç›´æ¥ç›¸è«‡ã—ãŸã„æ–¹ã¸"):
                        st.write("AIã®ææ¡ˆãŒã€ç›´ï¼ˆã™ãªãŠï¼‰ã€ãªæ„Ÿè¦šã¨ã—ã£ãã‚Šã“ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚")
                        with col1:
                            if st.button("åˆ¥ã®è¦–ç‚¹ã§å†åˆ†æã™ã‚‹"):
                                st.info("çŠ¶æ³ã‚’è©³ã—ãæ›¸ãè¶³ã—ã¦ã€ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„ã€‚")
                        with col2:
                            # è§£æ±ºï¼ˆå‡ºå£ï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒªãƒ³ã‚¯
                            st.link_button("ç›´æ¥å•ã„åˆã‚ã›ãƒ»å°‚é–€å®¶ã«ç›¸è«‡", "https://your-contact-link.com")
                    
                    st.markdown("---")
                    # ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã‚’ç¢ºå®Ÿã«ä¸€è¡Œã§è¨˜è¿°ã—ã€é–‰ã˜ã‚«ãƒƒã‚³ã‚’ä¿®æ­£
                    st.caption("æœ¬å†…å®¹ã¯åŒ»å­¦çš„è¨ºæ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯AIã®å­¦ç¿’ã«åˆ©ç”¨ã•ã‚Œãªã„å®‰å…¨ãªç’°å¢ƒã§å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚")
                    # ----------------------------------------------
                else:
                    st.error("AIã‹ã‚‰æœ‰åŠ¹ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")

            except Exception as e:
                st.error(f"ãƒ‡ãƒãƒƒã‚°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ (è©³ç´°: {e})")
    else:
        st.info("ã¾ãšã¯ä»Šã®çŠ¶æ³ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

