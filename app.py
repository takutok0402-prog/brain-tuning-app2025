import streamlit as st
import google.generativeai as genai
import os
import json

# --- 1. è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
st.set_page_config(page_title="SUNAO | Tuning", page_icon="ğŸ§ ", layout="centered")

# APIè¨­å®š
api_key = os.getenv("GEMINI_API_KEY") or st.secrets.get("GEMINI_API_KEY")
if api_key:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-2.5-flash')

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
for key in ['step', 'mode', 'brain_scan', 'mood_quadrant', 'selected_emotion']:
    if key not in st.session_state:
        st.session_state[key] = 1 if key == 'step' else None

# ç”»é¢é·ç§»
def move_to(step):
    st.session_state.step = step
    st.rerun()

# --- æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (æŸ”ã‚‰ã‹ã„è¡¨ç¾ã«å¤‰æ›´) ---
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œå¿ƒã®å£°ã€ã‚’ãã®ã¾ã¾é¸æŠè‚¢ã«ã—ã¦ã„ã¾ã™
EMOTION_DB = {
    # èµ¤: ã‚¨ãƒãƒ«ã‚®ãƒ¼é«˜ãƒ»ä¸å¿« (äº¤æ„Ÿç¥çµŒéæ´»å‹• / æ‰æ¡ƒä½“ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯)
    "Red": [
        "å¿ƒè‡“ãŒãƒã‚¯ãƒã‚¯ã™ã‚‹", "ã˜ã£ã¨ã—ã¦ã„ã‚‰ã‚Œãªã„", "é ­ãŒãƒ‘ãƒ³ã‚¯ã—ãã†", 
        "ä½•ã‹ã«è¿½ã‚ã‚Œã¦ã„ã‚‹æ°—ãŒã™ã‚‹", "ã‚¤ãƒ©ã‚¤ãƒ©ã—ã¦çˆ†ç™ºã—ãã†", "ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚Šãã†",
        "æ€–ãã¦ãŸã¾ã‚‰ãªã„", "ãƒ”ãƒªãƒ”ãƒªã—ã¦ã„ã‚‹", "å«ã³å‡ºã—ãŸã„", "è½ã¡ç€ã‹ãªã„"
    ],
    # é»„: ã‚¨ãƒãƒ«ã‚®ãƒ¼é«˜ãƒ»å¿« (ãƒ‰ãƒ¼ãƒ‘ãƒŸãƒ³ / ãƒ•ãƒ­ãƒ¼)
    "Yellow": [
        "ã‚„ã‚‹æ°—ã«æº€ã¡ã¦ã„ã‚‹", "ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¦ã„ã‚‹", "ã„ãã„ãã—ã¦ã„ã‚‹", 
        "é›†ä¸­ã§ãã¦ã„ã‚‹", "è‡ªä¿¡ãŒã‚ã‚‹", "æ–°ã—ã„ã“ã¨ã‚’ã—ãŸã„", 
        "ç›®ãŒå†´ãˆã¦ã„ã‚‹", "æ¥½ã—ã„äºˆæ„ŸãŒã™ã‚‹", "ã‚‚ã£ã¨å‹•ããŸã„"
    ],
    # é’: ã‚¨ãƒãƒ«ã‚®ãƒ¼ä½ãƒ»ä¸å¿« (DMNãƒ«ãƒ¼ãƒ— / ç–²å¼Š)
    "Blue": [
        "ã‚„ã‚‹æ°—ãŒå‡ºãªã„", "ãšã£ã¨è€ƒãˆã¦ã—ã¾ã†", "ä½•ã‚‚ã—ãŸããªã„", 
        "å¸ƒå›£ã‹ã‚‰å‡ºã‚‰ã‚Œãªã„", "æ¶ˆãˆã¦ã—ã¾ã„ãŸã„", "ãŸã‚æ¯ãŒå‡ºã‚‹", 
        "èƒ¸ãŒã‚®ãƒ¥ãƒƒã¨è‹¦ã—ã„", "æ¶™ãŒæ­¢ã¾ã‚‰ãªã„", "é ­ãŒã¼ãƒ¼ã£ã¨ã™ã‚‹", 
        "è‡ªåˆ†ãªã‚“ã¦ãƒ€ãƒ¡ã ", "æ˜”ã®ã“ã¨ã°ã‹ã‚Šæµ®ã‹ã¶", "ç–²ã‚Œæœã¦ãŸ"
    ],
    # ç·‘: ã‚¨ãƒãƒ«ã‚®ãƒ¼ä½ãƒ»å¿« (ã‚»ãƒ­ãƒˆãƒ‹ãƒ³ãƒ»ã‚ªã‚­ã‚·ãƒˆã‚·ãƒ³ / å®‰å®š)
    "Green": [
        "ã»ã£ã¨ã—ã¦ã„ã‚‹", "ç©ã‚„ã‹ãªæ°—æŒã¡", "ã®ã‚“ã³ã‚Šã§ãã¦ã„ã‚‹", 
        "è‚©ã®åŠ›ãŒæŠœã‘ã¦ã„ã‚‹", "ä»Šã®ã¾ã¾ã§ã„ã„", "å„ªã—ã„æ°—æŒã¡", 
        "å®‰å¿ƒã—ã¦ã„ã‚‹", "å‘¼å¸ãŒæ·±ã„", "å®ˆã‚‰ã‚Œã¦ã„ã‚‹æ„Ÿã˜"
    ]
}

# --- STEP 1: æ°—åˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ ---
if st.session_state.step == 1:
    st.title("ğŸŒˆ Step 1: ä»Šã®ã‚ãªãŸã®çŠ¶æ…‹")
    st.markdown("é ­ã§è€ƒãˆãšã€ä»Šã®**ã€Œä½“ã®æ„Ÿè¦šã€**ã«è¿‘ã„å ´æ‰€ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚")
    
    # 1. è±¡é™ã‚’æ±ºã‚ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    col1, col2 = st.columns(2)
    with col1:
        # ã‚¨ãƒãƒ«ã‚®ãƒ¼è¡¨ç¾ã‚‚ç›´æ„Ÿçš„ã«
        energy = st.select_slider("âš¡ ä½“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼", 
                                options=["å‹•ããŸããªã„", "ä½ã‚", "æ™®é€š", "é«˜ã‚", "æ­¢ã¾ã‚Œãªã„"], 
                                value="æ™®é€š")
    with col2:
        # å¿«ãƒ»ä¸å¿«è¡¨ç¾ã‚‚æŸ”ã‚‰ã‹ã
        pleasant = st.select_slider("ğŸƒ å¿ƒã®å¿ƒåœ°ã‚ˆã•", 
                                  options=["ãƒ¢ãƒ¤ãƒ¢ãƒ¤ãƒ»ã¤ã‚‰ã„", "å°‘ã—å«Œ", "æ™®é€š", "å°‘ã—è‰¯ã„", "å¿ƒåœ°ã‚ˆã„"], 
                                  value="æ™®é€š")
    
    # 2. è±¡é™åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§åˆ¤å®š)
    e_idx = ["å‹•ããŸããªã„", "ä½ã‚", "æ™®é€š", "é«˜ã‚", "æ­¢ã¾ã‚Œãªã„"].index(energy) - 2
    p_idx = ["ãƒ¢ãƒ¤ãƒ¢ãƒ¤ãƒ»ã¤ã‚‰ã„", "å°‘ã—å«Œ", "æ™®é€š", "å°‘ã—è‰¯ã„", "å¿ƒåœ°ã‚ˆã„"].index(pleasant) - 2
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    quadrant = "Green"
    q_label_text = "ç©ã‚„ã‹ãƒ»å®‰å®š"
    q_color = "success" # ç·‘
    
    if e_idx >= 0 and p_idx < 0:
        quadrant = "Red"
        q_label_text = "å¿ƒãŒã–ã‚ã¤ã„ã¦ã„ã‚‹ (ã‚¨ãƒãƒ«ã‚®ãƒ¼é«˜ãƒ»ãƒ¢ãƒ¤ãƒ¢ãƒ¤)"
        q_color = "error" # èµ¤
    elif e_idx >= 0 and p_idx >= 0:
        quadrant = "Yellow"
        q_label_text = "æ´»å‹•çš„ãƒ»ã„ãã„ã (ã‚¨ãƒãƒ«ã‚®ãƒ¼é«˜ãƒ»å¿ƒåœ°ã‚ˆã„)"
        q_color = "warning" # é»„
    elif e_idx < 0 and p_idx < 0:
        quadrant = "Blue"
        q_label_text = "ã‚¨ãƒãƒ«ã‚®ãƒ¼åˆ‡ã‚Œãƒ»æ²ˆã‚“ã§ã„ã‚‹ (ã‚¨ãƒãƒ«ã‚®ãƒ¼ä½ãƒ»ãƒ¢ãƒ¤ãƒ¢ãƒ¤)"
        q_color = "info" # é’
    else: # Low/Pleasant or Neutral
        quadrant = "Green"
        q_label_text = "ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ»å®‰å®š (ã‚¨ãƒãƒ«ã‚®ãƒ¼ä½ãƒ»å¿ƒåœ°ã‚ˆã„)"
        q_color = "success" # ç·‘

    # ã‚¨ãƒªã‚¢è¡¨ç¤ºï¼ˆè‹±èªæ’é™¤ï¼‰
    st.markdown(f"ä»Šã®ã‚¨ãƒªã‚¢ï¼š :{q_color}[**{q_label_text}**]")
    
    # 3. å…·ä½“çš„ãªè¨€è‘‰ã®é¸æŠ
    st.markdown("ä»Šã®æ°—åˆ†ã«ä¸€ç•ªè¿‘ã„è¨€è‘‰ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ")
    
    target_emotions = EMOTION_DB[quadrant]
    
    selected = st.selectbox("é¸ã‚“ã§ãã ã•ã„ï¼ˆç›´æ„Ÿã§OKï¼‰", ["(ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶)"] + target_emotions)
    
    if selected != "(ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶)":
        st.session_state.mood_quadrant = quadrant
        st.session_state.selected_emotion = selected
        
        st.markdown(f"ã‚ãªãŸã®çŠ¶æ…‹ï¼š **ã€Œ{selected}ã€**")
        
        if st.button("ã“ã®æ„Ÿè¦šã‚’AIã«ä¼ãˆã¦æ•´ãˆã‚‹ â”", type="primary", use_container_width=True):
            move_to(2)

# --- STEP 2: è„³å†…ã‚¹ã‚­ãƒ£ãƒ³ã¨AIè§£æ ---
elif st.session_state.step == 2:
    st.title("ğŸ” Step 2: è„³ã®ãƒ‡ãƒãƒƒã‚°")
    st.markdown(f"**ã€Œ{st.session_state.selected_emotion}ã€**ã¨æ„Ÿã˜ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚")
    st.markdown("ã‚‚ã—ã€ãã®æ°—æŒã¡ã«å…·ä½“çš„ãªç†ç”±ï¼ˆå‡ºæ¥äº‹ï¼‰ã‚„ã€ä½“ã®ç—›ã‚€å ´æ‰€ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚")
    
    user_input = st.text_area("ï¼ˆç©ºæ¬„ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ï¼‰", height=100, 
                            placeholder="ä¾‹ï¼šâ—‹â—‹ã«ã‚ˆã£ã¦éå»ã‚’æ€ã„å‡ºã—ã¦ã—ã¾ã£ãŸã€å‘¼å¸ãŒæµ…ã„ã€èƒƒãŒã‚­ãƒªã‚­ãƒªã™ã‚‹...")
    
    if st.button("è„³ã®çŠ¶æ…‹ã‚’åˆ†æã™ã‚‹ â”", use_container_width=True):
        if not api_key:
            st.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        else:
            with st.spinner("è„³ã®é…ç·šï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ï¼‰ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."):
                try:
                    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šå…¥åŠ›ã•ã‚ŒãŸã€Œè©±ã—è¨€è‘‰ã®æ„Ÿæƒ…ã€ã‚’å…ƒã«åˆ†æ
                    prompt = f"""
                    ã‚ãªãŸã¯ã€è„³ç¥çµŒç§‘å­¦ã«åŸºã¥ã„ãŸå„ªã—ã„èª¿å¾‹å¸«ã€ã§ã™ã€‚
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«åŸºã¥ãã€è„³ã®çŠ¶æ…‹ã‚’åˆ†æã—ã¦JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

                    ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘
                    - é¸æŠã•ã‚ŒãŸæ°—åˆ†: {st.session_state.selected_emotion}
                    - è£œè¶³æƒ…å ±: {user_input if user_input else "ç‰¹ã«ãªã—"}

                    ã€åˆ†æã®è¦–ç‚¹ã€‘
                    1. ã€Œ{st.session_state.selected_emotion}ã€ã¨ã„ã†çŠ¶æ…‹ã¯ã€è„³ã®ã©ã“ï¼ˆæ‰æ¡ƒä½“ or å‰é ­å‰é‡ or DMNï¼‰ãŒéæ´»å‹•ã«ãªã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã‹ï¼Ÿ
                    2. ãã®çŠ¶æ…‹ã¯ã€Œä¸€æ™‚çš„ãªè„³ã®ãƒã‚°ã€ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®æ€§æ ¼ã®å•é¡Œã§ã¯ãªã„ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ã€‚

                    ã€å‡ºåŠ›JSONã€‘
                    {{
                        "diagnosis": "çŸ­ã„è¦‹å‡ºã— (ä¾‹: éå»ã®è¨˜æ†¶ã«ã‚ˆã‚‹ã€æ‰æ¡ƒä½“ã‚¢ãƒ©ãƒ¼ãƒˆã€)",
                        "explanation": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å„ªã—ã„è§£èª¬ (ä¾‹: ä»Šã€è„³ãŒå±é™ºã‚’æ„Ÿã˜ã¦ã€é€ƒã’ã‚ã€ã¨å‘½ä»¤ã‚’å‡ºã—ã¦ã„ã¾ã™ã€‚ã ã‹ã‚‰å¿ƒè‡“ãŒãƒã‚¯ãƒã‚¯ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚ã‚ãªãŸã®å¼±ã•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚)",
                        "amygdala_level": 0-100,
                        "pfc_level": 0-100,
                        "mode": "reset" (æ‰æ¡ƒä½“æš´èµ°æ™‚) ã¾ãŸã¯ "tuning" (æ€è€ƒãƒ«ãƒ¼ãƒ—æ™‚),
                        "action_title": "1åˆ†ã§ã§ãã‚‹è„³ã®èª¿å¾‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å",
                        "action_detail": "å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ (ä¾‹: é’ã„ã‚‚ã®ã‚’3ã¤æ¢ã™ã€ãªã©)"
                    }}
                    """
                    response = model.generate_content(prompt)
                    cleaned = response.text.replace("```json", "").replace("```", "").strip()
                    st.session_state.brain_scan = json.loads(cleaned)
                    move_to(3)
                except Exception as e:
                    st.error(f"è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# --- STEP 3: è¨ºæ–­çµæœ ---
elif st.session_state.step == 3:
    scan = st.session_state.brain_scan
    st.title("ğŸ“‹ Step 3: åˆ†æãƒ¬ãƒãƒ¼ãƒˆ")
    
    st.subheader(f"âš¡ {scan['diagnosis']}")
    st.info(scan['explanation'])
    
    st.markdown("##### ğŸ§  ä»Šã®è„³å†…ãƒãƒ©ãƒ³ã‚¹")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f"**æ„Ÿæƒ…ã‚»ãƒ³ã‚µãƒ¼ (æ‰æ¡ƒä½“)**: {scan['amygdala_level']}%")
        st.progress(scan['amygdala_level']/100)
    with col2:
        st.markdown(f"**æ€è€ƒã‚¨ãƒ³ã‚¸ãƒ³ (å‰é ­å‰é‡)**: {scan['pfc_level']}%")
        st.progress(scan['pfc_level']/100)
        
    st.divider()
    
    st.subheader(f"ğŸ’Š ã‚ãªãŸã¸ã®å‡¦æ–¹ç®‹ï¼š{scan['action_title']}")
    st.success(scan['action_detail'])
    st.caption("â€» ã“ã‚Œã‚’è¡Œã†ã“ã¨ã§ã€è„³ã®ã‚¹ã‚¤ãƒƒãƒ(SN)ãŒ0.1åº¦ã ã‘æ­£å¸¸ãªä½ç½®ã«æˆ»ã‚Šã¾ã™ã€‚")
    
    if st.button("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹"):
        move_to(1)

